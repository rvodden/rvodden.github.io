<!doctype html><html lang=en><head>
<title>Writing a Geometric Solver in Python - Part 2: More Modelling</title>
<meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<meta name=viewport content="width=device-width,initial-scale=1">
<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script>
<script>window.MathJax={tex:{inlineMath:[['$','$'],['\\(','\\)']],displayMath:[['$$','$$'],['[',']']],processEscapes:!0,processEnvironments:!0},options:{skipHtmlTags:['script','noscript','style','textarea','pre']},startup:{pageReady(){return MathJax.startup.defaultPageReady().then(function(){var b=window.MathJax.startup.document.getMathItemsWithin(document.body),a;for(a=0;a<b.length;a+=1)console.log(b[a]),b[a].start.node.parentNode.className+=' has-jax'})}}}</script>
<link rel=stylesheet href=/scss/minima.f83841be025e6ffef4f520ea8061831cf9451762e86596f88c22710f1c4b0451.css integrity="sha256-+DhBvgJeb/709SDqgGGDHPlFF2LoZZb4jCJxDxxLBFE=">
<meta property="og:title" content="Writing a Geometric Solver in Python - Part 2: More Modelling">
<meta property="og:description" content="I describe, over the series, how to implement a geometric solver in Python. In this article we take the model from part one and extend it to allow constraints between higher order objects such as `Line` and `Circle`.
">
<meta property="og:type" content="article">
<meta property="og:url" content="https://vodden.com/posts/pysketcher-geometric-solver-2/"><meta property="article:section" content="posts">
<meta property="article:modified_time" content="2021-09-19T13:39:23+01:00">
<meta property="og:see_also" content="https://vodden.com/posts/constraining-the-point/">
<meta name=twitter:card content="summary">
<meta name=twitter:title content="Writing a Geometric Solver in Python - Part 2: More Modelling">
<meta name=twitter:description content="I describe, over the series, how to implement a geometric solver in Python. In this article we take the model from part one and extend it to allow constraints between higher order objects such as `Line` and `Circle`.
">
</head><body><header class=site-header role=banner>
<div class=wrapper>
<a class=site-title href=https://vodden.com/>
<img src=/truck.svg alt="Garbage Truck by Mat fine from the Noun Project" width=65px height=65px>
Garbage Collection
</a>
<nav class=site-nav>
<input type=checkbox id=nav-trigger class=nav-trigger>
<label for=nav-trigger>
<span class=menu-icon><svg viewBox="0 0 18 15" width="18" height="15"><path fill="#424242" d="M18 1.484c0 .82-.665 1.484-1.484 1.484H1.484C.665 2.969.0 2.304.0 1.484.0.665.665.0 1.484.0h15.031C17.335.0 18 .665 18 1.484z"/><path fill="#424242" d="M18 7.516C18 8.335 17.335 9 16.516 9H1.484C.665 9 0 8.335.0 7.516c0-.82.665-1.484 1.484-1.484h15.031C17.335 6.031 18 6.696 18 7.516z"/><path fill="#424242" d="M18 13.516C18 14.335 17.335 15 16.516 15H1.484C.665 15 0 14.335.0 13.516c0-.82.665-1.484 1.484-1.484h15.031C17.335 12.031 18 12.696 18 13.516z"/></svg>
</span>
</label>
<div class=trigger>
<a class=page-link href=/about/>Richard Vodden</a>
</div>
</nav>
</div>
</header>
<main class=page-content aria-label=Content>
<div class=wrapper>
<article class=post itemscope itemtype=http://schema.org/BlogPosting>
<header class=post-header>
<h1 class=post-title itemprop="name headline">Writing a Geometric Solver in Python - Part 2: More Modelling</h1>
<p class=post-meta>
<time datetime=2021-16-09 itemprop=datePublished>
16<sup>th</sup> February, 2021
</time>
</p>
</header>
<div class=post-content itemprop=articleBody>
<p>This is the second article in a short series about adding a geometric solver for my <a href=https://github.com/rvodden/pysketcher>PySketcher</a> side project. The basic premise is that instead of having to tell PySketcher exactly where you&rsquo;d like your shapes to be, you&rsquo;ll be able to specify the relationships the shapes have to each other, and PySketcher will be able to work our where they need to go. Have a read of <a href>Part 1</a> for more details, and for an explanation of how we&rsquo;ve built up the model so far.</p>
<h2 id=recapitulation>Recapitulation</h2>
<p>We&rsquo;ve built a model, which consists of a <code>ConstrainedValue</code> class. This class is a <code>Descriptor</code> and is assigned to classes. When <code>ConstrainedValue</code> is used in a class, that class will store <code>ConstraintSet</code> objects instead of raw values. This means that we can use the <code>constrain_with</code> method of <code>ConstraintSet</code> to indicate that the value of that <code>ConstraintSet</code> is in some way constrained. We built a trivial constraint <code>FixedValueConstraint</code> which indicates that the value ofa <code>ConstraintSet</code> is constrained to, unsurprisingly, a fixed value. We also built a<code>LinkedValueConstraint</code> which indicates that a <code>ConstraintSet</code> is constrained to the value of another <code>ConstraintSet</code>. We implemented a throwaway <code>resolve</code> method on <code>ConstraintSet</code> so that we can test how our model hangs together. Finally we spent some time ensuring that the experience was intuitive for people using the model, and that it was possible to interrogate the model to see how things are stitched together. Whilst we were considering the concepts above we implemented a small<code>Point</code> object and used that, with our throwaway <code>revolve</code> method, to illustrate that our modelling code is effective. The full code is available in <a href=https://gist.github.com/rvodden/c5d7d6ecea734006469d8dc758f9d1ae>this gist</a>, and this is an example of it in use:</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt id=1><a style=outline:none;text-decoration:none;color:inherit href=#1> 1</a>
</span><span class=lnt id=2><a style=outline:none;text-decoration:none;color:inherit href=#2> 2</a>
</span><span class=lnt id=3><a style=outline:none;text-decoration:none;color:inherit href=#3> 3</a>
</span><span class=lnt id=4><a style=outline:none;text-decoration:none;color:inherit href=#4> 4</a>
</span><span class=lnt id=5><a style=outline:none;text-decoration:none;color:inherit href=#5> 5</a>
</span><span class=lnt id=6><a style=outline:none;text-decoration:none;color:inherit href=#6> 6</a>
</span><span class=lnt id=7><a style=outline:none;text-decoration:none;color:inherit href=#7> 7</a>
</span><span class=lnt id=8><a style=outline:none;text-decoration:none;color:inherit href=#8> 8</a>
</span><span class=lnt id=9><a style=outline:none;text-decoration:none;color:inherit href=#9> 9</a>
</span><span class=lnt id=10><a style=outline:none;text-decoration:none;color:inherit href=#10>10</a>
</span><span class=lnt id=11><a style=outline:none;text-decoration:none;color:inherit href=#11>11</a>
</span><span class=lnt id=12><a style=outline:none;text-decoration:none;color:inherit href=#12>12</a>
</span><span class=lnt id=13><a style=outline:none;text-decoration:none;color:inherit href=#13>13</a>
</span><span class=lnt id=14><a style=outline:none;text-decoration:none;color:inherit href=#14>14</a>
</span><span class=lnt id=15><a style=outline:none;text-decoration:none;color:inherit href=#15>15</a>
</span><span class=lnt id=16><a style=outline:none;text-decoration:none;color:inherit href=#16>16</a>
</span><span class=lnt id=17><a style=outline:none;text-decoration:none;color:inherit href=#17>17</a>
</span><span class=lnt id=18><a style=outline:none;text-decoration:none;color:inherit href=#18>18</a>
</span><span class=lnt id=19><a style=outline:none;text-decoration:none;color:inherit href=#19>19</a>
</span><span class=lnt id=20><a style=outline:none;text-decoration:none;color:inherit href=#20>20</a>
</span><span class=lnt id=21><a style=outline:none;text-decoration:none;color:inherit href=#21>21</a>
</span><span class=lnt id=22><a style=outline:none;text-decoration:none;color:inherit href=#22>22</a>
</span><span class=lnt id=23><a style=outline:none;text-decoration:none;color:inherit href=#23>23</a>
</span><span class=lnt id=24><a style=outline:none;text-decoration:none;color:inherit href=#24>24</a>
</span><span class=lnt id=25><a style=outline:none;text-decoration:none;color:inherit href=#25>25</a>
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=c1>#... </span>
<span class=k>class</span> <span class=nc>Point</span><span class=p>:</span>
    <span class=n>x</span> <span class=o>=</span> <span class=n>ConstrainedValue</span><span class=p>()</span>
    <span class=n>y</span> <span class=o>=</span> <span class=n>ConstrainedValue</span><span class=p>()</span>

    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>name</span><span class=o>=</span><span class=s2>&#34;&#34;</span><span class=p>,</span> <span class=n>x</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span> <span class=n>y</span><span class=o>=</span><span class=kc>None</span><span class=p>):</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>_name</span> <span class=o>=</span> <span class=n>name</span>
        <span class=k>if</span> <span class=n>x</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>x</span> <span class=o>=</span> <span class=n>x</span>
        <span class=k>if</span> <span class=n>y</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span> <span class=p>:</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>y</span> <span class=o>=</span> <span class=n>y</span>

    <span class=nd>@property</span>
    <span class=k>def</span> <span class=nf>name</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>_name</span>

<span class=n>p</span> <span class=o>=</span> <span class=n>Point</span><span class=p>(</span><span class=s1>&#39;p&#39;</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span><span class=mi>2</span><span class=p>)</span>
<span class=n>q</span> <span class=o>=</span> <span class=n>Point</span><span class=p>(</span><span class=s1>&#39;q&#39;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;p.x is </span><span class=si>{</span><span class=n>p</span><span class=o>.</span><span class=n>x</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;p.x resolves to </span><span class=si>{</span><span class=n>p</span><span class=o>.</span><span class=n>x</span><span class=o>.</span><span class=n>resolve</span><span class=p>()</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
<span class=n>q</span><span class=o>.</span><span class=n>x</span> <span class=o>=</span> <span class=n>p</span><span class=o>.</span><span class=n>x</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;q.x is </span><span class=si>{</span><span class=nb>repr</span><span class=p>(</span><span class=n>q</span><span class=o>.</span><span class=n>x</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;q.x resolves to </span><span class=si>{</span><span class=n>q</span><span class=o>.</span><span class=n>x</span><span class=o>.</span><span class=n>resolve</span><span class=p>()</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
<span class=n>p</span><span class=o>.</span><span class=n>x</span> <span class=o>=</span> <span class=mi>2</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Now p.x has changed, q.x resolves to </span><span class=si>{</span><span class=n>q</span><span class=o>.</span><span class=n>x</span><span class=o>.</span><span class=n>resolve</span><span class=p>()</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</code></pre></td></tr></table>
</div>
</div><pre tabindex=0><code>p.x is p.x
p.x resolves to 1
q.x is ConstraintSet(
    LinkedValueConstraint&lt;p.x&gt;
)
q.x resolves to 1
Now p.x has changed, q.x resolves to 2
</code></pre><p>Top line stuff. We can define an object with some parameters and constrain those parameters using neat little constraints which are tiny standalone objects in themselves.</p>
<h2 id=drawing-a-line-under-it>Drawing a line under it</h2>
<p>Next, we&rsquo;d like to be able to represent more complex relationships. We may, for example, wish to constrain our point to being on a line, or perhaps on the circumference of a circle. In both of these examples the value of <code>x</code>is only known if the value of <code>y</code> is known and visa versa; yet neither can take arbitrary values.Before we consider how we might do that, let&rsquo;s build a simple line object. For the moment we won&rsquo;t worry about using <code>ConstrainedValue</code> in this line, as we wish to constrain the point to the line. We can revisit the <code>Line</code> object later on when we&rsquo;ve established some patterns.</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt id=1><a style=outline:none;text-decoration:none;color:inherit href=#1> 1</a>
</span><span class=lnt id=2><a style=outline:none;text-decoration:none;color:inherit href=#2> 2</a>
</span><span class=lnt id=3><a style=outline:none;text-decoration:none;color:inherit href=#3> 3</a>
</span><span class=lnt id=4><a style=outline:none;text-decoration:none;color:inherit href=#4> 4</a>
</span><span class=lnt id=5><a style=outline:none;text-decoration:none;color:inherit href=#5> 5</a>
</span><span class=lnt id=6><a style=outline:none;text-decoration:none;color:inherit href=#6> 6</a>
</span><span class=lnt id=7><a style=outline:none;text-decoration:none;color:inherit href=#7> 7</a>
</span><span class=lnt id=8><a style=outline:none;text-decoration:none;color:inherit href=#8> 8</a>
</span><span class=lnt id=9><a style=outline:none;text-decoration:none;color:inherit href=#9> 9</a>
</span><span class=lnt id=10><a style=outline:none;text-decoration:none;color:inherit href=#10>10</a>
</span><span class=lnt id=11><a style=outline:none;text-decoration:none;color:inherit href=#11>11</a>
</span><span class=lnt id=12><a style=outline:none;text-decoration:none;color:inherit href=#12>12</a>
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=k>class</span> <span class=nc>Line</span><span class=p>:</span>
    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>x1</span><span class=p>,</span> <span class=n>y1</span><span class=p>,</span> <span class=n>x2</span><span class=p>,</span> <span class=n>y2</span><span class=p>):</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>x1</span> <span class=o>=</span> <span class=n>x1</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>y1</span> <span class=o>=</span> <span class=n>y1</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>x2</span> <span class=o>=</span> <span class=n>x2</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>y2</span> <span class=o>=</span> <span class=n>y2</span>

    <span class=k>def</span> <span class=fm>__repr__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
        <span class=k>return</span> <span class=sa>f</span><span class=s2>&#34;Line&lt;(</span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>x1</span><span class=si>}</span><span class=s2>,</span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>y1</span><span class=si>}</span><span class=s2>),(</span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>x2</span><span class=si>}</span><span class=s2>,</span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>y2</span><span class=si>}</span><span class=s2>)&gt;&#34;</span>

<span class=n>l</span> <span class=o>=</span> <span class=n>Line</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span><span class=mi>1</span><span class=p>,</span><span class=mi>2</span><span class=p>,</span><span class=mi>3</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=n>l</span><span class=p>)</span>
</code></pre></td></tr></table>
</div>
</div><pre tabindex=0><code>Line&lt;(0,1),(2,3)&gt;
</code></pre><p>As you can see, we&rsquo;ve kept this super simple, and haven&rsquo;t even defined properties for <code>x1</code>, <code>x2</code>etc. It should serve our needs for the moment. Now how might we indicate that our <code>Point</code> is constrained to this line? The answer is surprisingly simple. The <code>Point</code> needs to be able to accept a constraint, and the easiest way to do that is to have it inherit from <code>ConstraintSet</code>:</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt id=1><a style=outline:none;text-decoration:none;color:inherit href=#1> 1</a>
</span><span class=lnt id=2><a style=outline:none;text-decoration:none;color:inherit href=#2> 2</a>
</span><span class=lnt id=3><a style=outline:none;text-decoration:none;color:inherit href=#3> 3</a>
</span><span class=lnt id=4><a style=outline:none;text-decoration:none;color:inherit href=#4> 4</a>
</span><span class=lnt id=5><a style=outline:none;text-decoration:none;color:inherit href=#5> 5</a>
</span><span class=lnt id=6><a style=outline:none;text-decoration:none;color:inherit href=#6> 6</a>
</span><span class=lnt id=7><a style=outline:none;text-decoration:none;color:inherit href=#7> 7</a>
</span><span class=lnt id=8><a style=outline:none;text-decoration:none;color:inherit href=#8> 8</a>
</span><span class=lnt id=9><a style=outline:none;text-decoration:none;color:inherit href=#9> 9</a>
</span><span class=lnt id=10><a style=outline:none;text-decoration:none;color:inherit href=#10>10</a>
</span><span class=lnt id=11><a style=outline:none;text-decoration:none;color:inherit href=#11>11</a>
</span><span class=lnt id=12><a style=outline:none;text-decoration:none;color:inherit href=#12>12</a>
</span><span class=lnt id=13><a style=outline:none;text-decoration:none;color:inherit href=#13>13</a>
</span><span class=lnt id=14><a style=outline:none;text-decoration:none;color:inherit href=#14>14</a>
</span><span class=lnt id=15><a style=outline:none;text-decoration:none;color:inherit href=#15>15</a>
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=k>class</span> <span class=nc>Point</span><span class=p>(</span><span class=n>ConstraintSet</span><span class=p>):</span>
    <span class=n>x</span> <span class=o>=</span> <span class=n>ConstrainedValue</span><span class=p>()</span>
    <span class=n>y</span> <span class=o>=</span> <span class=n>ConstrainedValue</span><span class=p>()</span>

    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>name</span><span class=o>=</span><span class=s2>&#34;&#34;</span><span class=p>,</span> <span class=n>x</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span> <span class=n>y</span><span class=o>=</span><span class=kc>None</span><span class=p>):</span>
        <span class=nb>super</span><span class=p>()</span><span class=o>.</span><span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>_name</span> <span class=o>=</span> <span class=n>name</span>
        <span class=k>if</span> <span class=n>x</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>x</span> <span class=o>=</span> <span class=n>x</span>
        <span class=k>if</span> <span class=n>y</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span> <span class=p>:</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>y</span> <span class=o>=</span> <span class=n>y</span>

    <span class=nd>@property</span>
    <span class=k>def</span> <span class=nf>name</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>_name</span>
</code></pre></td></tr></table>
</div>
</div><p>Here the only changes are the first line of the class, which specifies <code>ConstraintSet</code> as a superclass, and the first line of <code>__init__</code> which adds the call to the superclass initializer. As we&rsquo;ve now inherited from <code>ConstraintSet</code>, our <code>Point</code> class has a <code>constrain_with</code> method which can use to supply a <code>Constraint</code> which indicates that our point should be constrained to a <code>Line</code>. The fancy pants maths people say that if a point is on a line, then it &ldquo;coincident&rdquo;, so let&rsquo;s use their fancy pants language and define a <code>CoincidentConstraint</code>:</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt id=1><a style=outline:none;text-decoration:none;color:inherit href=#1> 1</a>
</span><span class=lnt id=2><a style=outline:none;text-decoration:none;color:inherit href=#2> 2</a>
</span><span class=lnt id=3><a style=outline:none;text-decoration:none;color:inherit href=#3> 3</a>
</span><span class=lnt id=4><a style=outline:none;text-decoration:none;color:inherit href=#4> 4</a>
</span><span class=lnt id=5><a style=outline:none;text-decoration:none;color:inherit href=#5> 5</a>
</span><span class=lnt id=6><a style=outline:none;text-decoration:none;color:inherit href=#6> 6</a>
</span><span class=lnt id=7><a style=outline:none;text-decoration:none;color:inherit href=#7> 7</a>
</span><span class=lnt id=8><a style=outline:none;text-decoration:none;color:inherit href=#8> 8</a>
</span><span class=lnt id=9><a style=outline:none;text-decoration:none;color:inherit href=#9> 9</a>
</span><span class=lnt id=10><a style=outline:none;text-decoration:none;color:inherit href=#10>10</a>
</span><span class=lnt id=11><a style=outline:none;text-decoration:none;color:inherit href=#11>11</a>
</span><span class=lnt id=12><a style=outline:none;text-decoration:none;color:inherit href=#12>12</a>
</span><span class=lnt id=13><a style=outline:none;text-decoration:none;color:inherit href=#13>13</a>
</span><span class=lnt id=14><a style=outline:none;text-decoration:none;color:inherit href=#14>14</a>
</span><span class=lnt id=15><a style=outline:none;text-decoration:none;color:inherit href=#15>15</a>
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=k>class</span> <span class=nc>CoincidentConstraint</span><span class=p>(</span><span class=n>Constraint</span><span class=p>):</span>
    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>line</span><span class=p>):</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>_line</span> <span class=o>=</span> <span class=n>line</span>

    <span class=nd>@property</span>
    <span class=k>def</span> <span class=nf>line</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>_line</span>

    <span class=k>def</span> <span class=fm>__repr__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
        <span class=k>return</span> <span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=vm>__class__</span><span class=o>.</span><span class=vm>__name__</span><span class=si>}</span><span class=s2>&lt;</span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>line</span><span class=si>}</span><span class=s2>&gt;&#34;</span>

<span class=n>l</span> <span class=o>=</span> <span class=n>Line</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span><span class=mi>2</span><span class=p>,</span><span class=mi>3</span><span class=p>,</span><span class=mi>4</span><span class=p>)</span>
<span class=n>p</span> <span class=o>=</span> <span class=n>Point</span><span class=p>(</span><span class=s1>&#39;p&#39;</span><span class=p>)</span>
<span class=n>p</span><span class=o>.</span><span class=n>constrain_with</span><span class=p>(</span><span class=n>CoincidentConstraint</span><span class=p>(</span><span class=n>l</span><span class=p>))</span>
<span class=nb>print</span><span class=p>(</span><span class=nb>repr</span><span class=p>(</span><span class=n>p</span><span class=p>))</span>
</code></pre></td></tr></table>
</div>
</div><pre tabindex=0><code>ConstraintSet(
    CoincidentConstraint&lt;Line&lt;(1,2),(3,4)&gt;&gt;
)
</code></pre><h2 id=crisis-of-identity>Crisis of identity</h2>
<p>Well our point is now telling us that it&rsquo;s constrained, and is listing out the constraints correctly, but it seems to be having a bit of an identity crisis. It&rsquo;s telling us that it&rsquo;s a<code>ConstraintSet</code>, and whilst that is true to a certain extent, it should really tell us that it is a<code>Point</code>. The issue is because when we originally wrote the <code>__repr__</code> method in <code>ConstraintSet</code> we hardcoded the class name (tsk). Let&rsquo;s address that:</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt id=1><a style=outline:none;text-decoration:none;color:inherit href=#1> 1</a>
</span><span class=lnt id=2><a style=outline:none;text-decoration:none;color:inherit href=#2> 2</a>
</span><span class=lnt id=3><a style=outline:none;text-decoration:none;color:inherit href=#3> 3</a>
</span><span class=lnt id=4><a style=outline:none;text-decoration:none;color:inherit href=#4> 4</a>
</span><span class=lnt id=5><a style=outline:none;text-decoration:none;color:inherit href=#5> 5</a>
</span><span class=lnt id=6><a style=outline:none;text-decoration:none;color:inherit href=#6> 6</a>
</span><span class=lnt id=7><a style=outline:none;text-decoration:none;color:inherit href=#7> 7</a>
</span><span class=lnt id=8><a style=outline:none;text-decoration:none;color:inherit href=#8> 8</a>
</span><span class=lnt id=9><a style=outline:none;text-decoration:none;color:inherit href=#9> 9</a>
</span><span class=lnt id=10><a style=outline:none;text-decoration:none;color:inherit href=#10>10</a>
</span><span class=lnt id=11><a style=outline:none;text-decoration:none;color:inherit href=#11>11</a>
</span><span class=lnt id=12><a style=outline:none;text-decoration:none;color:inherit href=#12>12</a>
</span><span class=lnt id=13><a style=outline:none;text-decoration:none;color:inherit href=#13>13</a>
</span><span class=lnt id=14><a style=outline:none;text-decoration:none;color:inherit href=#14>14</a>
</span><span class=lnt id=15><a style=outline:none;text-decoration:none;color:inherit href=#15>15</a>
</span><span class=lnt id=16><a style=outline:none;text-decoration:none;color:inherit href=#16>16</a>
</span><span class=lnt id=17><a style=outline:none;text-decoration:none;color:inherit href=#17>17</a>
</span><span class=lnt id=18><a style=outline:none;text-decoration:none;color:inherit href=#18>18</a>
</span><span class=lnt id=19><a style=outline:none;text-decoration:none;color:inherit href=#19>19</a>
</span><span class=lnt id=20><a style=outline:none;text-decoration:none;color:inherit href=#20>20</a>
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=k>class</span> <span class=nc>ConstraintSet</span><span class=p>:</span>
<span class=c1>#... </span>

    <span class=k>def</span> <span class=fm>__repr__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
        <span class=n>retval</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=vm>__class__</span><span class=o>.</span><span class=vm>__name__</span><span class=si>}</span><span class=s2>(&#34;</span>
        <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_constraints</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
            <span class=n>retval</span> <span class=o>+=</span> <span class=s2>&#34;)&#34;</span>
            <span class=k>return</span> <span class=n>retval</span>

        <span class=k>for</span> <span class=n>constraint</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>_constraints</span><span class=p>:</span>
            <span class=n>retval</span> <span class=o>+=</span> <span class=sa>f</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>    </span><span class=si>{</span><span class=n>constraint</span><span class=si>}</span><span class=s2>&#34;</span>
        <span class=n>retval</span> <span class=o>+=</span> <span class=s2>&#34;</span><span class=se>\n</span><span class=s2>)&#34;</span>
        <span class=k>return</span> <span class=n>retval</span>

<span class=c1>#... </span>

<span class=n>l</span> <span class=o>=</span> <span class=n>Line</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span><span class=mi>2</span><span class=p>,</span><span class=mi>3</span><span class=p>,</span><span class=mi>4</span><span class=p>)</span>
<span class=n>p</span> <span class=o>=</span> <span class=n>Point</span><span class=p>(</span><span class=s1>&#39;p&#39;</span><span class=p>)</span>
<span class=n>p</span><span class=o>.</span><span class=n>constrain_with</span><span class=p>(</span><span class=n>CoincidentConstraint</span><span class=p>(</span><span class=n>l</span><span class=p>))</span>
<span class=nb>print</span><span class=p>(</span><span class=nb>repr</span><span class=p>(</span><span class=n>p</span><span class=p>))</span>
</code></pre></td></tr></table>
</div>
</div><pre tabindex=0><code>Point(
    CoincidentConstraint&lt;Line&lt;(1,2),(3,4)&gt;&gt;
)
</code></pre><p>Excellent! Our <code>Point</code> is a <code>Point</code> again, and its correctly reporting its constraints.</p>
<h2 id=cascading-constraints>Cascading Constraints</h2>
<p>What happens if we look at the co-ordinates of the <code>Point</code>?</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt id=1><a style=outline:none;text-decoration:none;color:inherit href=#1>1</a>
</span><span class=lnt id=2><a style=outline:none;text-decoration:none;color:inherit href=#2>2</a>
</span><span class=lnt id=3><a style=outline:none;text-decoration:none;color:inherit href=#3>3</a>
</span><span class=lnt id=4><a style=outline:none;text-decoration:none;color:inherit href=#4>4</a>
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=n>l</span> <span class=o>=</span> <span class=n>Line</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span><span class=mi>2</span><span class=p>,</span><span class=mi>3</span><span class=p>,</span><span class=mi>4</span><span class=p>)</span>
<span class=n>p</span> <span class=o>=</span> <span class=n>Point</span><span class=p>(</span><span class=s1>&#39;p&#39;</span><span class=p>)</span>
<span class=n>p</span><span class=o>.</span><span class=n>constrain_with</span><span class=p>(</span><span class=n>CoincidentConstraint</span><span class=p>(</span><span class=n>l</span><span class=p>))</span>
<span class=nb>print</span><span class=p>(</span><span class=nb>repr</span><span class=p>(</span><span class=n>p</span><span class=o>.</span><span class=n>x</span><span class=p>))</span>
</code></pre></td></tr></table>
</div>
</div><pre tabindex=0><code>ConstraintSet()
</code></pre><p>That&rsquo;s not so good. Whilst it is true that we have not directly constrained the <code>x</code> coordinate, it is not true that the <code>x</code> coordinate is not constrained. It would be much better if the <code>x</code>coordinate could tell us that it was being constrained by the <code>CoincidentConstraint</code> at the <code>Point</code> level.We could just have the <code>constrain_with</code> method apply the <code>CoincidentConstraint</code> to the <code>x</code> and <code>y</code>coordinates, and this is certainly a valid approach.</p>
<p>However, let&rsquo;s think more broadly than our current scenario for a moment. We may, for example, be constraining a line to be horizontal. A line (or at least our line) is defined by two points, which in turn are each defined by two values, their <code>x</code> and <code>y</code> co-ordinates. Constraining a line to being horizontal is only constraining the <code>y</code> co-ordinates of those two point (constraining them to being equal) and there is no way that our <code>constrain_with</code> method can know this. If we were to just apply the <code>HorizontalConstraint</code> to all the properties then we&rsquo;d end up with the <code>x</code> co-ordinates showing the that they were constrained, which is misleading.</p>
<p>So we need an alternative approach. It is only really our <code>Constraint</code> implementations which will understand which properties need to be constrained. So we need a mechanism for the <code>constrain_with</code>method to give the constraint the means to, in turn, constrain the properties of the object it is constraining. To achieve this we&rsquo;ll use a design pattern called a &ldquo;callback&rdquo;. We&rsquo;ll define a <code>constrain_callback</code> method on the <code>Constraint</code> which accepts a <code>ConstraintSet</code> object.Then we will update our <code>constrain_with</code> method to call that <code>constrain_callback</code> method. The<code>constrain_callback</code> method can then be overridden by the various implementations of <code>Constraint</code> to apply the necessary downstream constraints.</p>
<p>So step 1, we need to modify our <code>Constraint</code> definition to include a <code>constraint_callback</code> method.We face a design decision at this point. We can either declare this method to be an<code>@abstractmethod</code> which will force implementations of <code>Constraint</code> to implement it, or we can provide a default implementation, which will do nothing, meaning that our implementations can just pretend the <code>constraint_callback</code> doesn&rsquo;t exist if they don&rsquo;t wish to constrain properties. It&rsquo;s not particularly clear which direction we should go here. If we provide a default implementation then we risk our users forgetting that it needs to be implemented, and therefore some nasty bugs. If we don&rsquo;t then implementations will have to explicitly state that they want the <code>constraint_callback</code> to do nothing. This is simply a question of style, neither option is particularly better than the other. For pythonic questions of style we should always refer to <a href=https://www.python.org/dev/peps/pep-0020/>PEP20 - the zen of python</a> and yet again, in this case, it does not let us down. Rule 2 is &ldquo;Explicit is better than implicit.&rdquo; so rather than providing a default implementation which implicitly does nothing, we will require our implementations to provide an explicit implementation of the method which does nothing (if that&rsquo;s what they require). In practice this means that we will decorate our method with <code>@abstractmethod</code>:</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt id=1><a style=outline:none;text-decoration:none;color:inherit href=#1>1</a>
</span><span class=lnt id=2><a style=outline:none;text-decoration:none;color:inherit href=#2>2</a>
</span><span class=lnt id=3><a style=outline:none;text-decoration:none;color:inherit href=#3>3</a>
</span><span class=lnt id=4><a style=outline:none;text-decoration:none;color:inherit href=#4>4</a>
</span><span class=lnt id=5><a style=outline:none;text-decoration:none;color:inherit href=#5>5</a>
</span><span class=lnt id=6><a style=outline:none;text-decoration:none;color:inherit href=#6>6</a>
</span><span class=lnt id=7><a style=outline:none;text-decoration:none;color:inherit href=#7>7</a>
</span><span class=lnt id=8><a style=outline:none;text-decoration:none;color:inherit href=#8>8</a>
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=kn>from</span> <span class=nn>abc</span> <span class=kn>import</span> <span class=n>ABC</span><span class=p>,</span> <span class=n>abstractmethod</span>

<span class=k>class</span> <span class=nc>Constraint</span><span class=p>(</span><span class=n>ABC</span><span class=p>):</span>
    <span class=s2>&#34;&#34;&#34;Used to restrict that value of a `ConstrainedValue`.&#34;&#34;&#34;</span>

    <span class=nd>@abstractmethod</span>
    <span class=k>def</span> <span class=nf>constraint_callback</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>instance</span><span class=p>):</span>
        <span class=k>raise</span> <span class=ne>NotImplementedError</span><span class=p>(</span><span class=s2>&#34;`constraint_callback` must be implemented explicitly.&#34;</span><span class=p>)</span>
</code></pre></td></tr></table>
</div>
</div><p>And as a direct result of our design decision we need to update our constraints to include a definition of that method. In the case of <code>FixedValueConstraint</code> and <code>LinkedValueConstraint</code> it can simply do nothing. <code>CoincidentConstraint</code> is a touch more complicated so we&rsquo;ll look at that a little later.</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt id=1><a style=outline:none;text-decoration:none;color:inherit href=#1>1</a>
</span><span class=lnt id=2><a style=outline:none;text-decoration:none;color:inherit href=#2>2</a>
</span><span class=lnt id=3><a style=outline:none;text-decoration:none;color:inherit href=#3>3</a>
</span><span class=lnt id=4><a style=outline:none;text-decoration:none;color:inherit href=#4>4</a>
</span><span class=lnt id=5><a style=outline:none;text-decoration:none;color:inherit href=#5>5</a>
</span><span class=lnt id=6><a style=outline:none;text-decoration:none;color:inherit href=#6>6</a>
</span><span class=lnt id=7><a style=outline:none;text-decoration:none;color:inherit href=#7>7</a>
</span><span class=lnt id=8><a style=outline:none;text-decoration:none;color:inherit href=#8>8</a>
</span><span class=lnt id=9><a style=outline:none;text-decoration:none;color:inherit href=#9>9</a>
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=k>class</span> <span class=nc>FixedValueConstraint</span><span class=p>(</span><span class=n>Constraint</span><span class=p>):</span>
<span class=c1>#... </span>
    <span class=k>def</span> <span class=nf>constraint_callback</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>instance</span><span class=p>):</span>
        <span class=k>pass</span>

<span class=k>class</span> <span class=nc>LinkedValueConstraint</span><span class=p>(</span><span class=n>Constraint</span><span class=p>):</span>
<span class=c1>#... </span>
    <span class=k>def</span> <span class=nf>constraint_callback</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>instance</span><span class=p>):</span>
        <span class=k>pass</span>
</code></pre></td></tr></table>
</div>
</div><p>Step two is to update our <code>constrain_with</code> method to call the callback:</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt id=1><a style=outline:none;text-decoration:none;color:inherit href=#1>1</a>
</span><span class=lnt id=2><a style=outline:none;text-decoration:none;color:inherit href=#2>2</a>
</span><span class=lnt id=3><a style=outline:none;text-decoration:none;color:inherit href=#3>3</a>
</span><span class=lnt id=4><a style=outline:none;text-decoration:none;color:inherit href=#4>4</a>
</span><span class=lnt id=5><a style=outline:none;text-decoration:none;color:inherit href=#5>5</a>
</span><span class=lnt id=6><a style=outline:none;text-decoration:none;color:inherit href=#6>6</a>
</span><span class=lnt id=7><a style=outline:none;text-decoration:none;color:inherit href=#7>7</a>
</span><span class=lnt id=8><a style=outline:none;text-decoration:none;color:inherit href=#8>8</a>
</span><span class=lnt id=9><a style=outline:none;text-decoration:none;color:inherit href=#9>9</a>
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=k>class</span> <span class=nc>ConstraintSet</span><span class=p>:</span>
<span class=c1>#... </span>

    <span class=k>def</span> <span class=nf>constrain_with</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>constraint</span><span class=p>):</span>
        <span class=n>constraint</span><span class=o>.</span><span class=n>constraint_callback</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span>
        <span class=s2>&#34;&#34;&#34;Add a constraint to this objects list of constraints.&#34;&#34;&#34;</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>_constraints</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>constraint</span><span class=p>)</span>

<span class=c1>#... </span>
</code></pre></td></tr></table>
</div>
</div><p>Now we need to decide how we&rsquo;re going to actually constrain the parameters. One approach could be to apply the <code>CoincidentConstraint</code> to the <code>x</code> and <code>y</code>. I&rsquo;ve thought about this, and I can&rsquo;t see a reason why it technically wouldn&rsquo;t work, however it does create an ambiguity. It would not be clear if the <code>CoincidentConstraint</code> had been applied directly to the <code>x</code> or if it had inherited it from its parent shape. So to avoid this we&rsquo;re going to create an <code>InfluencedConstraint</code>. This new constraint will indicate that the parameter is constrained by something higher up the food chain.</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt id=1><a style=outline:none;text-decoration:none;color:inherit href=#1> 1</a>
</span><span class=lnt id=2><a style=outline:none;text-decoration:none;color:inherit href=#2> 2</a>
</span><span class=lnt id=3><a style=outline:none;text-decoration:none;color:inherit href=#3> 3</a>
</span><span class=lnt id=4><a style=outline:none;text-decoration:none;color:inherit href=#4> 4</a>
</span><span class=lnt id=5><a style=outline:none;text-decoration:none;color:inherit href=#5> 5</a>
</span><span class=lnt id=6><a style=outline:none;text-decoration:none;color:inherit href=#6> 6</a>
</span><span class=lnt id=7><a style=outline:none;text-decoration:none;color:inherit href=#7> 7</a>
</span><span class=lnt id=8><a style=outline:none;text-decoration:none;color:inherit href=#8> 8</a>
</span><span class=lnt id=9><a style=outline:none;text-decoration:none;color:inherit href=#9> 9</a>
</span><span class=lnt id=10><a style=outline:none;text-decoration:none;color:inherit href=#10>10</a>
</span><span class=lnt id=11><a style=outline:none;text-decoration:none;color:inherit href=#11>11</a>
</span><span class=lnt id=12><a style=outline:none;text-decoration:none;color:inherit href=#12>12</a>
</span><span class=lnt id=13><a style=outline:none;text-decoration:none;color:inherit href=#13>13</a>
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=k>class</span> <span class=nc>InfluencedConstraint</span><span class=p>(</span><span class=n>Constraint</span><span class=p>):</span>
    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>constraint</span><span class=p>):</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>_constraint</span> <span class=o>=</span> <span class=n>constraint</span>

    <span class=k>def</span> <span class=nf>constraint_callback</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>instance</span><span class=p>):</span>
        <span class=k>pass</span>

    <span class=nd>@property</span>
    <span class=k>def</span> <span class=nf>constraint</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>_constraint</span>

    <span class=k>def</span> <span class=fm>__repr__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
        <span class=k>return</span> <span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=vm>__class__</span><span class=o>.</span><span class=vm>__name__</span><span class=si>}</span><span class=s2>&lt;</span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>constraint</span><span class=si>}</span><span class=s2>&gt;&#34;</span>
</code></pre></td></tr></table>
</div>
</div><p>Now we&rsquo;re ready to implement the <code>callback_constraint</code> method on the <code>CoincidentConstraint</code> to have it indicate that it is influencing the two co-ordinates.</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt id=1><a style=outline:none;text-decoration:none;color:inherit href=#1>1</a>
</span><span class=lnt id=2><a style=outline:none;text-decoration:none;color:inherit href=#2>2</a>
</span><span class=lnt id=3><a style=outline:none;text-decoration:none;color:inherit href=#3>3</a>
</span><span class=lnt id=4><a style=outline:none;text-decoration:none;color:inherit href=#4>4</a>
</span><span class=lnt id=5><a style=outline:none;text-decoration:none;color:inherit href=#5>5</a>
</span><span class=lnt id=6><a style=outline:none;text-decoration:none;color:inherit href=#6>6</a>
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=k>class</span> <span class=nc>CoincidentConstraint</span><span class=p>(</span><span class=n>Constraint</span><span class=p>):</span>
<span class=c1>#... </span>

    <span class=k>def</span> <span class=nf>constraint_callback</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>point</span><span class=p>):</span>
        <span class=n>point</span><span class=o>.</span><span class=n>x</span><span class=o>.</span><span class=n>constrain_with</span><span class=p>(</span><span class=n>InfluencedConstraint</span><span class=p>(</span><span class=bp>self</span><span class=p>))</span>
        <span class=n>point</span><span class=o>.</span><span class=n>y</span><span class=o>.</span><span class=n>constrain_with</span><span class=p>(</span><span class=n>InfluencedConstraint</span><span class=p>(</span><span class=bp>self</span><span class=p>))</span>
</code></pre></td></tr></table>
</div>
</div><p>Let&rsquo;s take this for a spin and see how it goes!</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt id=1><a style=outline:none;text-decoration:none;color:inherit href=#1>1</a>
</span><span class=lnt id=2><a style=outline:none;text-decoration:none;color:inherit href=#2>2</a>
</span><span class=lnt id=3><a style=outline:none;text-decoration:none;color:inherit href=#3>3</a>
</span><span class=lnt id=4><a style=outline:none;text-decoration:none;color:inherit href=#4>4</a>
</span><span class=lnt id=5><a style=outline:none;text-decoration:none;color:inherit href=#5>5</a>
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=n>l</span> <span class=o>=</span> <span class=n>Line</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span><span class=mi>2</span><span class=p>,</span><span class=mi>3</span><span class=p>,</span><span class=mi>4</span><span class=p>)</span>
<span class=n>p</span> <span class=o>=</span> <span class=n>Point</span><span class=p>(</span><span class=s1>&#39;p&#39;</span><span class=p>)</span>
<span class=n>p</span><span class=o>.</span><span class=n>constrain_with</span><span class=p>(</span><span class=n>CoincidentConstraint</span><span class=p>(</span><span class=n>l</span><span class=p>))</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;p is </span><span class=si>{</span><span class=nb>repr</span><span class=p>(</span><span class=n>p</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;p.x is </span><span class=si>{</span><span class=nb>repr</span><span class=p>(</span><span class=n>p</span><span class=o>.</span><span class=n>x</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</code></pre></td></tr></table>
</div>
</div><pre tabindex=0><code>p is Point(
    CoincidentConstraint&lt;Line&lt;(1,2),(3,4)&gt;&gt;
)
p.x is ConstraintSet(
    InfluencedConstraint&lt;CoincidentConstraint&lt;Line&lt;(1,2),(3,4)&gt;&gt;&gt;
)
</code></pre><p>That looks ideal. The <code>Point</code> object is expressing that it is constrained by the<code>CoincidentConstraint</code> and if we look at the <code>x</code> coordinate we can see that it is influenced by the<code>CoincidentConstraint</code> and even see exactly which line the <code>CoincidentConstraint</code> is constraining to. This might get a bit verbose in complex diagrams, but right now its perfect for our needs, so let&rsquo;s leave it like that and worry about verbosity if and when it becomes an issue.</p>
<h2 id=what-type-of-fool-do-you-take-me-for>What type of fool do you take me for?</h2>
<p>Let&rsquo;s try something a little off the wall. Let&rsquo;s try constraining <code>p.x</code> with a<code>CoincidentConstraint</code>. As <code>CoincidentConstraint</code> is only designed to apply to <code>Point</code> objects, it&rsquo;s likely to do something a little strange when applied to a <code>ConstraintSet</code>:</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt id=1><a style=outline:none;text-decoration:none;color:inherit href=#1>1</a>
</span><span class=lnt id=2><a style=outline:none;text-decoration:none;color:inherit href=#2>2</a>
</span><span class=lnt id=3><a style=outline:none;text-decoration:none;color:inherit href=#3>3</a>
</span><span class=lnt id=4><a style=outline:none;text-decoration:none;color:inherit href=#4>4</a>
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=n>l</span> <span class=o>=</span> <span class=n>Line</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span><span class=mi>2</span><span class=p>,</span><span class=mi>3</span><span class=p>,</span><span class=mi>4</span><span class=p>)</span>
<span class=n>p</span> <span class=o>=</span> <span class=n>Point</span><span class=p>(</span><span class=s1>&#39;p&#39;</span><span class=p>)</span>
<span class=n>p</span><span class=o>.</span><span class=n>x</span><span class=o>.</span><span class=n>constrain_with</span><span class=p>(</span><span class=n>CoincidentConstraint</span><span class=p>(</span><span class=n>l</span><span class=p>))</span>
<span class=nb>print</span><span class=p>(</span><span class=nb>repr</span><span class=p>(</span><span class=n>p</span><span class=o>.</span><span class=n>x</span><span class=p>))</span>
</code></pre></td></tr></table>
</div>
</div><pre tabindex=0><code>AttributeError: 'ConstraintSet' object has no attribute 'x'
</code></pre><p>Oh dear! This isn&rsquo;t a very helpful error message is it? Whilst in our simple example its probably easy enough to work out what has gone on, more complex scenarios could lead to some real head scratching. To resolve this, let&rsquo;s have the <code>constraint_callback</code> check that the constraint is being applied to a sensible object. In this case it only really makes sense for<code>CoincidentConstraint</code> to be applied to a <code>Point</code>, so let&rsquo;s enforce that. And let&rsquo;s create a custom<code>RuntimeError</code> object with a nice error message to tell our users what is going on.</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt id=1><a style=outline:none;text-decoration:none;color:inherit href=#1> 1</a>
</span><span class=lnt id=2><a style=outline:none;text-decoration:none;color:inherit href=#2> 2</a>
</span><span class=lnt id=3><a style=outline:none;text-decoration:none;color:inherit href=#3> 3</a>
</span><span class=lnt id=4><a style=outline:none;text-decoration:none;color:inherit href=#4> 4</a>
</span><span class=lnt id=5><a style=outline:none;text-decoration:none;color:inherit href=#5> 5</a>
</span><span class=lnt id=6><a style=outline:none;text-decoration:none;color:inherit href=#6> 6</a>
</span><span class=lnt id=7><a style=outline:none;text-decoration:none;color:inherit href=#7> 7</a>
</span><span class=lnt id=8><a style=outline:none;text-decoration:none;color:inherit href=#8> 8</a>
</span><span class=lnt id=9><a style=outline:none;text-decoration:none;color:inherit href=#9> 9</a>
</span><span class=lnt id=10><a style=outline:none;text-decoration:none;color:inherit href=#10>10</a>
</span><span class=lnt id=11><a style=outline:none;text-decoration:none;color:inherit href=#11>11</a>
</span><span class=lnt id=12><a style=outline:none;text-decoration:none;color:inherit href=#12>12</a>
</span><span class=lnt id=13><a style=outline:none;text-decoration:none;color:inherit href=#13>13</a>
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-python data-lang=python>
<span class=k>class</span> <span class=nc>InvalidConstraintException</span><span class=p>(</span><span class=ne>RuntimeError</span><span class=p>):</span>
    <span class=s2>&#34;&#34;&#34;Indicates that a constraint has been applied to an object which doesn&#39;t make sense.&#34;&#34;&#34;</span>

<span class=k>class</span> <span class=nc>CoincidentConstraint</span><span class=p>(</span><span class=n>Constraint</span><span class=p>):</span>
<span class=c1>#... </span>

    <span class=k>def</span> <span class=nf>constraint_callback</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>point</span><span class=p>):</span>
        <span class=k>if</span> <span class=ow>not</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>point</span><span class=p>,</span> <span class=n>Point</span><span class=p>):</span>
            <span class=k>raise</span> <span class=n>InvalidConstraintException</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=vm>__class__</span><span class=o>.</span><span class=vm>__name__</span><span class=si>}</span><span class=s2> can only&#34;</span>
            <span class=sa>f</span><span class=s2>&#34; be applied to `Point`, it cannot be applied to `</span><span class=si>{</span><span class=n>point</span><span class=o>.</span><span class=vm>__class__</span><span class=o>.</span><span class=vm>__name__</span><span class=si>}</span><span class=s2>`&#34;</span><span class=p>)</span>
        <span class=n>point</span><span class=o>.</span><span class=n>x</span><span class=o>.</span><span class=n>constrain_with</span><span class=p>(</span><span class=n>InfluencedConstraint</span><span class=p>(</span><span class=bp>self</span><span class=p>))</span>
        <span class=n>point</span><span class=o>.</span><span class=n>y</span><span class=o>.</span><span class=n>constrain_with</span><span class=p>(</span><span class=n>InfluencedConstraint</span><span class=p>(</span><span class=bp>self</span><span class=p>))</span>
</code></pre></td></tr></table>
</div>
</div><p>Let&rsquo;s see how that&rsquo;s improved things:</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt id=1><a style=outline:none;text-decoration:none;color:inherit href=#1>1</a>
</span><span class=lnt id=2><a style=outline:none;text-decoration:none;color:inherit href=#2>2</a>
</span><span class=lnt id=3><a style=outline:none;text-decoration:none;color:inherit href=#3>3</a>
</span><span class=lnt id=4><a style=outline:none;text-decoration:none;color:inherit href=#4>4</a>
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=n>l</span> <span class=o>=</span> <span class=n>Line</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span><span class=mi>2</span><span class=p>,</span><span class=mi>3</span><span class=p>,</span><span class=mi>4</span><span class=p>)</span>
<span class=n>p</span> <span class=o>=</span> <span class=n>Point</span><span class=p>(</span><span class=s1>&#39;p&#39;</span><span class=p>)</span>
<span class=n>p</span><span class=o>.</span><span class=n>x</span><span class=o>.</span><span class=n>constrain_with</span><span class=p>(</span><span class=n>CoincidentConstraint</span><span class=p>(</span><span class=n>l</span><span class=p>))</span>
<span class=nb>print</span><span class=p>(</span><span class=nb>repr</span><span class=p>(</span><span class=n>p</span><span class=o>.</span><span class=n>x</span><span class=p>))</span>
</code></pre></td></tr></table>
</div>
</div><pre tabindex=0><code>InvalidConstraintException: CoincidentConstraint can only be applied to `Point`, it cannot be applied to `ConstraintSet`.
</code></pre><p>This is much better, and likely to save our developers a chunk of time as compared with the old"missing attribute" error message. Spoiler alert though, this specific implementation will come back to bite us in the next section. Comment if you can see why, and no cheating by reading the next section first!</p>
<h2 id=one-way-or-another>One way or another.</h2>
<p>Let&rsquo;s take stock of where we have got to. We have a nice strong framework for expressing geometric constraints as <code>Constraint</code> objects, and we have a clean way of applying these to our geometric objects. We have clear output when we ask the various objects to <code>repr</code> themselves, and we have clear error messages when things don&rsquo;t quite go to plan. There are just a couple of corners we need to clear up before we can call ourselves done. Look at the following example:</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt id=1><a style=outline:none;text-decoration:none;color:inherit href=#1>1</a>
</span><span class=lnt id=2><a style=outline:none;text-decoration:none;color:inherit href=#2>2</a>
</span><span class=lnt id=3><a style=outline:none;text-decoration:none;color:inherit href=#3>3</a>
</span><span class=lnt id=4><a style=outline:none;text-decoration:none;color:inherit href=#4>4</a>
</span><span class=lnt id=5><a style=outline:none;text-decoration:none;color:inherit href=#5>5</a>
</span><span class=lnt id=6><a style=outline:none;text-decoration:none;color:inherit href=#6>6</a>
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=n>p</span> <span class=o>=</span> <span class=n>Point</span><span class=p>(</span><span class=s1>&#39;p&#39;</span><span class=p>)</span>
<span class=n>q</span> <span class=o>=</span> <span class=n>Point</span><span class=p>(</span><span class=s1>&#39;q&#39;</span><span class=p>)</span>

<span class=n>q</span><span class=o>.</span><span class=n>x</span> <span class=o>=</span> <span class=n>p</span><span class=o>.</span><span class=n>x</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;p.x is </span><span class=si>{</span><span class=nb>repr</span><span class=p>(</span><span class=n>p</span><span class=o>.</span><span class=n>x</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;q.x is </span><span class=si>{</span><span class=nb>repr</span><span class=p>(</span><span class=n>q</span><span class=o>.</span><span class=n>x</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</code></pre></td></tr></table>
</div>
</div><pre tabindex=0><code>p.x is ConstraintSet()
q.x is ConstraintSet(
    LinkedValueConstraint&lt;p.x&gt;
)
</code></pre><p>This is a tremendously powerful thing to be able to do. We can create a point and say nothing about it, then refer to it in constraints. What would happen, though, if we were solving our constraint system (the subject of a later article) and <code>q</code> was given a value first? Equality is a reciprocal condition, and when we assert that <code>q.x = p.x</code> we are equally saying that <code>p.x = q.x</code>.We could force this on our users. We could decide that for the purposes of our geometric solver,such operations are not reciprocal, and that users must specify both sides of the relationship:</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt id=1><a style=outline:none;text-decoration:none;color:inherit href=#1>1</a>
</span><span class=lnt id=2><a style=outline:none;text-decoration:none;color:inherit href=#2>2</a>
</span><span class=lnt id=3><a style=outline:none;text-decoration:none;color:inherit href=#3>3</a>
</span><span class=lnt id=4><a style=outline:none;text-decoration:none;color:inherit href=#4>4</a>
</span><span class=lnt id=5><a style=outline:none;text-decoration:none;color:inherit href=#5>5</a>
</span><span class=lnt id=6><a style=outline:none;text-decoration:none;color:inherit href=#6>6</a>
</span><span class=lnt id=7><a style=outline:none;text-decoration:none;color:inherit href=#7>7</a>
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=n>p</span> <span class=o>=</span> <span class=n>Point</span><span class=p>(</span><span class=s1>&#39;p&#39;</span><span class=p>)</span>
<span class=n>q</span> <span class=o>=</span> <span class=n>Point</span><span class=p>(</span><span class=s1>&#39;q&#39;</span><span class=p>)</span>

<span class=n>q</span><span class=o>.</span><span class=n>x</span> <span class=o>=</span> <span class=n>p</span><span class=o>.</span><span class=n>x</span>
<span class=n>p</span><span class=o>.</span><span class=n>x</span> <span class=o>=</span> <span class=n>q</span><span class=o>.</span><span class=n>x</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;p.x is </span><span class=si>{</span><span class=nb>repr</span><span class=p>(</span><span class=n>p</span><span class=o>.</span><span class=n>x</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;q.x is </span><span class=si>{</span><span class=nb>repr</span><span class=p>(</span><span class=n>q</span><span class=o>.</span><span class=n>x</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</code></pre></td></tr></table>
</div>
</div><pre tabindex=0><code>p.x is ConstraintSet(
    LinkedValueConstraint&lt;q.x&gt;
)
q.x is ConstraintSet(
    LinkedValueConstraint&lt;p.x&gt;
)
</code></pre><p>Whilst this does tick the PEP20 &ldquo;explicit is better than implicit&rdquo; rule, rule three of the same says"Simple is better than complex". I&rsquo;m reasonably sure that every geometric relationship is in someway reciprocal. If <code>l</code> is parallel to <code>m</code> then <code>m</code> is parallel to <code>l</code>. Even with our<code>CoincidentConstraint</code> if our point is on the line, then our line must go through the point. Let&rsquo;s update our <code>LinkedValueConstraint</code> to apply the reciprocal constraint.</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt id=1><a style=outline:none;text-decoration:none;color:inherit href=#1>1</a>
</span><span class=lnt id=2><a style=outline:none;text-decoration:none;color:inherit href=#2>2</a>
</span><span class=lnt id=3><a style=outline:none;text-decoration:none;color:inherit href=#3>3</a>
</span><span class=lnt id=4><a style=outline:none;text-decoration:none;color:inherit href=#4>4</a>
</span><span class=lnt id=5><a style=outline:none;text-decoration:none;color:inherit href=#5>5</a>
</span><span class=lnt id=6><a style=outline:none;text-decoration:none;color:inherit href=#6>6</a>
</span><span class=lnt id=7><a style=outline:none;text-decoration:none;color:inherit href=#7>7</a>
</span><span class=lnt id=8><a style=outline:none;text-decoration:none;color:inherit href=#8>8</a>
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=k>class</span> <span class=nc>LinkedValueConstraint</span><span class=p>(</span><span class=n>Constraint</span><span class=p>):</span>
<span class=c1>#... </span>
    <span class=k>def</span> <span class=nf>constraint_callback</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>instance</span><span class=p>):</span>
        <span class=k>if</span> <span class=ow>not</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>instance</span><span class=p>,</span> <span class=n>ConstraintSet</span><span class=p>):</span>
            <span class=k>raise</span> <span class=n>InvalidConstraintException</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=vm>__class__</span><span class=o>.</span><span class=vm>__name__</span><span class=si>}</span><span class=s2> can only&#34;</span>
            <span class=sa>f</span><span class=s2>&#34; be applied to `ConstraintSet`, it cannot be applied to `</span><span class=si>{</span><span class=n>point</span><span class=o>.</span><span class=vm>__class__</span><span class=o>.</span><span class=vm>__name__</span><span class=si>}</span><span class=s2>`&#34;</span><span class=p>)</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>constraint_set</span><span class=o>.</span><span class=n>constrain_with</span><span class=p>(</span><span class=n>LinkedValueConstraint</span><span class=p>(</span><span class=n>instance</span><span class=p>))</span>
        <span class=k>pass</span>
</code></pre></td></tr></table>
</div>
</div><p>And let&rsquo;s try again:</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt id=1><a style=outline:none;text-decoration:none;color:inherit href=#1>1</a>
</span><span class=lnt id=2><a style=outline:none;text-decoration:none;color:inherit href=#2>2</a>
</span><span class=lnt id=3><a style=outline:none;text-decoration:none;color:inherit href=#3>3</a>
</span><span class=lnt id=4><a style=outline:none;text-decoration:none;color:inherit href=#4>4</a>
</span><span class=lnt id=5><a style=outline:none;text-decoration:none;color:inherit href=#5>5</a>
</span><span class=lnt id=6><a style=outline:none;text-decoration:none;color:inherit href=#6>6</a>
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=n>p</span> <span class=o>=</span> <span class=n>Point</span><span class=p>(</span><span class=s1>&#39;p&#39;</span><span class=p>)</span>
<span class=n>q</span> <span class=o>=</span> <span class=n>Point</span><span class=p>(</span><span class=s1>&#39;q&#39;</span><span class=p>)</span>

<span class=n>q</span><span class=o>.</span><span class=n>x</span> <span class=o>=</span> <span class=n>p</span><span class=o>.</span><span class=n>x</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;p.x is </span><span class=si>{</span><span class=nb>repr</span><span class=p>(</span><span class=n>p</span><span class=o>.</span><span class=n>x</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;q.x is </span><span class=si>{</span><span class=nb>repr</span><span class=p>(</span><span class=n>q</span><span class=o>.</span><span class=n>x</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</code></pre></td></tr></table>
</div>
</div><pre tabindex=0><code>RecursionError: maximum recursion depth exceeded while calling a Python object
</code></pre><p>Oops! What&rsquo;s going on here? Well the problem is that the <code>LinkedValueConstraint</code> applies a reciprocal constraint by enforcing a <code>LinkedValueConstraint</code> on the original <code>ConstraintSet</code> which in turn tries to apply a reciprocal constraint etc. And the whole world explodes in a glorious stack overflow (first one of the project though, I&rsquo;m proud!). We could fix this by adding some kind of flag to <code>constrain_with</code> and <code>constraint_callback</code> to indicate that this is a reciprocal call and that they should not apply the reciprocal constraint as its already done. This is crying out to be forgotten and to lead to some nasty stack overflow type bugs. I think a neater solution is to have<code>constrain_with</code> check to see if an identical constraint has already been applied and just exit cleanly if it has. To do this we need to establish what it means for two <code>LinkedValueConstraints</code> to be equal:</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt id=1><a style=outline:none;text-decoration:none;color:inherit href=#1>1</a>
</span><span class=lnt id=2><a style=outline:none;text-decoration:none;color:inherit href=#2>2</a>
</span><span class=lnt id=3><a style=outline:none;text-decoration:none;color:inherit href=#3>3</a>
</span><span class=lnt id=4><a style=outline:none;text-decoration:none;color:inherit href=#4>4</a>
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=k>class</span> <span class=nc>LinkedValueConstraint</span><span class=p>(</span><span class=n>Constraint</span><span class=p>):</span>
<span class=c1>#... </span>
    <span class=k>def</span> <span class=fm>__eq__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>other</span><span class=p>):</span>
        <span class=k>return</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>other</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=vm>__class__</span><span class=p>)</span> <span class=ow>and</span> <span class=bp>self</span><span class=o>.</span><span class=n>constraint_set</span> <span class=o>==</span> <span class=n>other</span><span class=o>.</span><span class=n>constraint_set</span>
</code></pre></td></tr></table>
</div>
</div><p>Here we&rsquo;ve said that a <code>LinkedValueConstraint</code> is only equal to another object, if and only if that other object is also a <code>LinkedValueConstraint</code> and they are both linked to the same <code>ConstraintSet</code>.</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt id=1><a style=outline:none;text-decoration:none;color:inherit href=#1>1</a>
</span><span class=lnt id=2><a style=outline:none;text-decoration:none;color:inherit href=#2>2</a>
</span><span class=lnt id=3><a style=outline:none;text-decoration:none;color:inherit href=#3>3</a>
</span><span class=lnt id=4><a style=outline:none;text-decoration:none;color:inherit href=#4>4</a>
</span><span class=lnt id=5><a style=outline:none;text-decoration:none;color:inherit href=#5>5</a>
</span><span class=lnt id=6><a style=outline:none;text-decoration:none;color:inherit href=#6>6</a>
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=n>p</span> <span class=o>=</span> <span class=n>Point</span><span class=p>()</span>
<span class=n>l</span> <span class=o>=</span> <span class=n>LinkedValueConstraint</span><span class=p>(</span><span class=n>p</span><span class=o>.</span><span class=n>x</span><span class=p>)</span>
<span class=n>m</span> <span class=o>=</span> <span class=n>LinkedValueConstraint</span><span class=p>(</span><span class=n>p</span><span class=o>.</span><span class=n>x</span><span class=p>)</span>
<span class=n>n</span> <span class=o>=</span> <span class=n>LinkedValueConstraint</span><span class=p>(</span><span class=n>q</span><span class=o>.</span><span class=n>x</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;l == m: </span><span class=si>{</span><span class=n>l</span> <span class=o>==</span> <span class=n>m</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;l == n: </span><span class=si>{</span><span class=n>l</span> <span class=o>==</span> <span class=n>n</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</code></pre></td></tr></table>
</div>
</div><pre tabindex=0><code>l == m: True
l == n: False
</code></pre><p>And let&rsquo;s stitch this into our <code>constrain_with</code> method:</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt id=1><a style=outline:none;text-decoration:none;color:inherit href=#1> 1</a>
</span><span class=lnt id=2><a style=outline:none;text-decoration:none;color:inherit href=#2> 2</a>
</span><span class=lnt id=3><a style=outline:none;text-decoration:none;color:inherit href=#3> 3</a>
</span><span class=lnt id=4><a style=outline:none;text-decoration:none;color:inherit href=#4> 4</a>
</span><span class=lnt id=5><a style=outline:none;text-decoration:none;color:inherit href=#5> 5</a>
</span><span class=lnt id=6><a style=outline:none;text-decoration:none;color:inherit href=#6> 6</a>
</span><span class=lnt id=7><a style=outline:none;text-decoration:none;color:inherit href=#7> 7</a>
</span><span class=lnt id=8><a style=outline:none;text-decoration:none;color:inherit href=#8> 8</a>
</span><span class=lnt id=9><a style=outline:none;text-decoration:none;color:inherit href=#9> 9</a>
</span><span class=lnt id=10><a style=outline:none;text-decoration:none;color:inherit href=#10>10</a>
</span><span class=lnt id=11><a style=outline:none;text-decoration:none;color:inherit href=#11>11</a>
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=k>class</span> <span class=nc>ConstraintSet</span><span class=p>:</span>
<span class=c1>#... </span>

    <span class=k>def</span> <span class=nf>constrain_with</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>constraint</span><span class=p>):</span>
        <span class=k>if</span> <span class=n>constraint</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>_constraints</span><span class=p>:</span>
            <span class=k>return</span>
        <span class=n>constraint</span><span class=o>.</span><span class=n>constraint_callback</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span>
        <span class=s2>&#34;&#34;&#34;Add a constraint to this objects list of constraints.&#34;&#34;&#34;</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>_constraints</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>constraint</span><span class=p>)</span>

<span class=c1>#... </span>
</code></pre></td></tr></table>
</div>
</div><p>Let&rsquo;s see if that solved our stack overflow:</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt id=1><a style=outline:none;text-decoration:none;color:inherit href=#1>1</a>
</span><span class=lnt id=2><a style=outline:none;text-decoration:none;color:inherit href=#2>2</a>
</span><span class=lnt id=3><a style=outline:none;text-decoration:none;color:inherit href=#3>3</a>
</span><span class=lnt id=4><a style=outline:none;text-decoration:none;color:inherit href=#4>4</a>
</span><span class=lnt id=5><a style=outline:none;text-decoration:none;color:inherit href=#5>5</a>
</span><span class=lnt id=6><a style=outline:none;text-decoration:none;color:inherit href=#6>6</a>
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=n>p</span> <span class=o>=</span> <span class=n>Point</span><span class=p>(</span><span class=s1>&#39;p&#39;</span><span class=p>)</span>
<span class=n>q</span> <span class=o>=</span> <span class=n>Point</span><span class=p>(</span><span class=s1>&#39;q&#39;</span><span class=p>)</span>

<span class=n>q</span><span class=o>.</span><span class=n>x</span> <span class=o>=</span> <span class=n>p</span><span class=o>.</span><span class=n>x</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;p.x is </span><span class=si>{</span><span class=nb>repr</span><span class=p>(</span><span class=n>p</span><span class=o>.</span><span class=n>x</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;q.x is </span><span class=si>{</span><span class=nb>repr</span><span class=p>(</span><span class=n>q</span><span class=o>.</span><span class=n>x</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</code></pre></td></tr></table>
</div>
</div><pre tabindex=0><code>RecursionError: maximum recursion depth exceeded
</code></pre><p>It didn&rsquo;t! Nightmare! The issue here is that we are using the <code>constraint_callback</code> to apply the reciprocal constraint, but that is being called before the constraint is added to<code>self._constraints</code> in the <code>Constraint</code> class. We need it to be that way around because the<code>constraint_callback</code> is also validating that the object is of a suitable type. Aha! This is our issue. Every time we have to use the work &ldquo;also&rdquo; to describe what an object or method is doing, then we likely have ourselves a separation of concerns issue. This was the mistake which I gave you the spoiler alert for earlier! Let&rsquo;s split our <code>constraint_callback</code> into three: a <code>validate_object</code> method, an <code>apply_reciprocal_constraint</code> method, and finally the<code>cascade_constraints</code>.</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt id=1><a style=outline:none;text-decoration:none;color:inherit href=#1> 1</a>
</span><span class=lnt id=2><a style=outline:none;text-decoration:none;color:inherit href=#2> 2</a>
</span><span class=lnt id=3><a style=outline:none;text-decoration:none;color:inherit href=#3> 3</a>
</span><span class=lnt id=4><a style=outline:none;text-decoration:none;color:inherit href=#4> 4</a>
</span><span class=lnt id=5><a style=outline:none;text-decoration:none;color:inherit href=#5> 5</a>
</span><span class=lnt id=6><a style=outline:none;text-decoration:none;color:inherit href=#6> 6</a>
</span><span class=lnt id=7><a style=outline:none;text-decoration:none;color:inherit href=#7> 7</a>
</span><span class=lnt id=8><a style=outline:none;text-decoration:none;color:inherit href=#8> 8</a>
</span><span class=lnt id=9><a style=outline:none;text-decoration:none;color:inherit href=#9> 9</a>
</span><span class=lnt id=10><a style=outline:none;text-decoration:none;color:inherit href=#10>10</a>
</span><span class=lnt id=11><a style=outline:none;text-decoration:none;color:inherit href=#11>11</a>
</span><span class=lnt id=12><a style=outline:none;text-decoration:none;color:inherit href=#12>12</a>
</span><span class=lnt id=13><a style=outline:none;text-decoration:none;color:inherit href=#13>13</a>
</span><span class=lnt id=14><a style=outline:none;text-decoration:none;color:inherit href=#14>14</a>
</span><span class=lnt id=15><a style=outline:none;text-decoration:none;color:inherit href=#15>15</a>
</span><span class=lnt id=16><a style=outline:none;text-decoration:none;color:inherit href=#16>16</a>
</span><span class=lnt id=17><a style=outline:none;text-decoration:none;color:inherit href=#17>17</a>
</span><span class=lnt id=18><a style=outline:none;text-decoration:none;color:inherit href=#18>18</a>
</span><span class=lnt id=19><a style=outline:none;text-decoration:none;color:inherit href=#19>19</a>
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=kn>from</span> <span class=nn>abc</span> <span class=kn>import</span> <span class=n>ABC</span><span class=p>,</span> <span class=n>abstractmethod</span>

<span class=k>class</span> <span class=nc>Constraint</span><span class=p>(</span><span class=n>ABC</span><span class=p>):</span>
    <span class=s2>&#34;&#34;&#34;Used to restrict that value of a ```ConstrainedValue```.&#34;&#34;&#34;</span>

    <span class=nd>@abstractmethod</span>
    <span class=k>def</span> <span class=nf>validate_object</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>instance</span><span class=p>):</span>
        <span class=s2>&#34;&#34;&#34;Validates that `instance` is suitable. Raises `InvalidConstraintException` if not&#34;&#34;&#34;</span>
        <span class=k>raise</span> <span class=ne>NotImplementedError</span><span class=p>(</span><span class=s2>&#34;`validate_object` must be implemented explicitly.&#34;</span><span class=p>)</span>

    <span class=nd>@abstractmethod</span>
    <span class=k>def</span> <span class=nf>apply_reciprocal_constraint</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>instance</span><span class=p>):</span>
        <span class=s2>&#34;&#34;&#34;Applies a matching constraint to the provided instance.&#34;&#34;&#34;</span>
        <span class=k>raise</span> <span class=ne>NotImplementedError</span><span class=p>(</span><span class=s2>&#34;`apply_reciprocal_callback` must be implemented explicitly.&#34;</span><span class=p>)</span>

    <span class=nd>@abstractmethod</span>
    <span class=k>def</span> <span class=nf>cascade_constraints</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>instance</span><span class=p>):</span>
        <span class=s2>&#34;&#34;&#34;Applies appropriate constraints to the properties of `instance`.&#34;&#34;&#34;</span>
        <span class=k>raise</span> <span class=ne>NotImplementedError</span><span class=p>(</span><span class=s2>&#34;`cascade_constraints` must be implemented explicitly.&#34;</span><span class=p>)</span>
</code></pre></td></tr></table>
</div>
</div><p>And let&rsquo;s update our <code>LinkedValueConstraint</code>:</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt id=1><a style=outline:none;text-decoration:none;color:inherit href=#1> 1</a>
</span><span class=lnt id=2><a style=outline:none;text-decoration:none;color:inherit href=#2> 2</a>
</span><span class=lnt id=3><a style=outline:none;text-decoration:none;color:inherit href=#3> 3</a>
</span><span class=lnt id=4><a style=outline:none;text-decoration:none;color:inherit href=#4> 4</a>
</span><span class=lnt id=5><a style=outline:none;text-decoration:none;color:inherit href=#5> 5</a>
</span><span class=lnt id=6><a style=outline:none;text-decoration:none;color:inherit href=#6> 6</a>
</span><span class=lnt id=7><a style=outline:none;text-decoration:none;color:inherit href=#7> 7</a>
</span><span class=lnt id=8><a style=outline:none;text-decoration:none;color:inherit href=#8> 8</a>
</span><span class=lnt id=9><a style=outline:none;text-decoration:none;color:inherit href=#9> 9</a>
</span><span class=lnt id=10><a style=outline:none;text-decoration:none;color:inherit href=#10>10</a>
</span><span class=lnt id=11><a style=outline:none;text-decoration:none;color:inherit href=#11>11</a>
</span><span class=lnt id=12><a style=outline:none;text-decoration:none;color:inherit href=#12>12</a>
</span><span class=lnt id=13><a style=outline:none;text-decoration:none;color:inherit href=#13>13</a>
</span><span class=lnt id=14><a style=outline:none;text-decoration:none;color:inherit href=#14>14</a>
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=k>class</span> <span class=nc>LinkedValueConstraint</span><span class=p>(</span><span class=n>Constraint</span><span class=p>):</span>
<span class=c1>#... </span>
    <span class=k>def</span> <span class=nf>validate_object</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>instance</span><span class=p>):</span>
        <span class=k>if</span> <span class=ow>not</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>instance</span><span class=p>,</span> <span class=n>ConstraintSet</span><span class=p>):</span>
            <span class=k>raise</span> <span class=n>InvalidConstraintException</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=vm>__class__</span><span class=o>.</span><span class=vm>__name__</span><span class=si>}</span><span class=s2> can only&#34;</span>
            <span class=sa>f</span><span class=s2>&#34; be applied to `ConstraintSet`, it cannot be applied to `</span><span class=si>{</span><span class=n>point</span><span class=o>.</span><span class=vm>__class__</span><span class=o>.</span><span class=vm>__name__</span><span class=si>}</span><span class=s2>`&#34;</span><span class=p>)</span>

    <span class=k>def</span> <span class=nf>apply_reciprocal_constraint</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>instance</span><span class=p>):</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>constraint_set</span><span class=o>.</span><span class=n>constrain_with</span><span class=p>(</span><span class=n>LinkedValueConstraint</span><span class=p>(</span><span class=n>instance</span><span class=p>))</span>

    <span class=k>def</span> <span class=nf>cascade_constraints</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>instance</span><span class=p>):</span>
        <span class=k>pass</span>
<span class=c1>#... </span>

</code></pre></td></tr></table>
</div>
</div><p>And finally sort out <code>ConstraintSet</code>:</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt id=1><a style=outline:none;text-decoration:none;color:inherit href=#1> 1</a>
</span><span class=lnt id=2><a style=outline:none;text-decoration:none;color:inherit href=#2> 2</a>
</span><span class=lnt id=3><a style=outline:none;text-decoration:none;color:inherit href=#3> 3</a>
</span><span class=lnt id=4><a style=outline:none;text-decoration:none;color:inherit href=#4> 4</a>
</span><span class=lnt id=5><a style=outline:none;text-decoration:none;color:inherit href=#5> 5</a>
</span><span class=lnt id=6><a style=outline:none;text-decoration:none;color:inherit href=#6> 6</a>
</span><span class=lnt id=7><a style=outline:none;text-decoration:none;color:inherit href=#7> 7</a>
</span><span class=lnt id=8><a style=outline:none;text-decoration:none;color:inherit href=#8> 8</a>
</span><span class=lnt id=9><a style=outline:none;text-decoration:none;color:inherit href=#9> 9</a>
</span><span class=lnt id=10><a style=outline:none;text-decoration:none;color:inherit href=#10>10</a>
</span><span class=lnt id=11><a style=outline:none;text-decoration:none;color:inherit href=#11>11</a>
</span><span class=lnt id=12><a style=outline:none;text-decoration:none;color:inherit href=#12>12</a>
</span><span class=lnt id=13><a style=outline:none;text-decoration:none;color:inherit href=#13>13</a>
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=k>class</span> <span class=nc>ConstraintSet</span><span class=p>:</span>
<span class=c1>#... </span>

    <span class=k>def</span> <span class=nf>constrain_with</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>constraint</span><span class=p>):</span>
        <span class=n>constraint</span><span class=o>.</span><span class=n>validate_object</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span>
        <span class=k>if</span> <span class=n>constraint</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>_constraints</span><span class=p>:</span>
            <span class=k>return</span>
        <span class=s2>&#34;&#34;&#34;Add a constraint to this objects list of constraints.&#34;&#34;&#34;</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>_constraints</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>constraint</span><span class=p>)</span>
        <span class=n>constraint</span><span class=o>.</span><span class=n>cascade_constraints</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span>
        <span class=n>constraint</span><span class=o>.</span><span class=n>apply_reciprocal_constraint</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span>

<span class=c1>#... </span>
</code></pre></td></tr></table>
</div>
</div><p>This has had the happy effect of making the <code>constrain_with</code> method much more readable. Let&rsquo;s see if its finally resolved our stack overflow.</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt id=1><a style=outline:none;text-decoration:none;color:inherit href=#1>1</a>
</span><span class=lnt id=2><a style=outline:none;text-decoration:none;color:inherit href=#2>2</a>
</span><span class=lnt id=3><a style=outline:none;text-decoration:none;color:inherit href=#3>3</a>
</span><span class=lnt id=4><a style=outline:none;text-decoration:none;color:inherit href=#4>4</a>
</span><span class=lnt id=5><a style=outline:none;text-decoration:none;color:inherit href=#5>5</a>
</span><span class=lnt id=6><a style=outline:none;text-decoration:none;color:inherit href=#6>6</a>
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=n>p</span> <span class=o>=</span> <span class=n>Point</span><span class=p>(</span><span class=s1>&#39;p&#39;</span><span class=p>)</span>
<span class=n>q</span> <span class=o>=</span> <span class=n>Point</span><span class=p>(</span><span class=s1>&#39;q&#39;</span><span class=p>)</span>

<span class=n>q</span><span class=o>.</span><span class=n>x</span> <span class=o>=</span> <span class=n>p</span><span class=o>.</span><span class=n>x</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;p.x is </span><span class=si>{</span><span class=nb>repr</span><span class=p>(</span><span class=n>p</span><span class=o>.</span><span class=n>x</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;q.x is </span><span class=si>{</span><span class=nb>repr</span><span class=p>(</span><span class=n>q</span><span class=o>.</span><span class=n>x</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</code></pre></td></tr></table>
</div>
</div><pre tabindex=0><code>p.x is ConstraintSet(
    LinkedValueConstraint&lt;q.x&gt;
)
q.x is ConstraintSet(
    LinkedValueConstraint&lt;p.x&gt;
)
</code></pre><p>Hooray! That was a surprising amount of work for the apparently simple task of implementing reciprocal relationships!</p>
<h2 id=wrapping-it-all-up>Wrapping it all up</h2>
<p>As a final flourish we need to update our existing constraints to have these new methods. Our<code>FixedValueConstraint</code> is trivial, we shall just implement each as a no-op:</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt id=1><a style=outline:none;text-decoration:none;color:inherit href=#1> 1</a>
</span><span class=lnt id=2><a style=outline:none;text-decoration:none;color:inherit href=#2> 2</a>
</span><span class=lnt id=3><a style=outline:none;text-decoration:none;color:inherit href=#3> 3</a>
</span><span class=lnt id=4><a style=outline:none;text-decoration:none;color:inherit href=#4> 4</a>
</span><span class=lnt id=5><a style=outline:none;text-decoration:none;color:inherit href=#5> 5</a>
</span><span class=lnt id=6><a style=outline:none;text-decoration:none;color:inherit href=#6> 6</a>
</span><span class=lnt id=7><a style=outline:none;text-decoration:none;color:inherit href=#7> 7</a>
</span><span class=lnt id=8><a style=outline:none;text-decoration:none;color:inherit href=#8> 8</a>
</span><span class=lnt id=9><a style=outline:none;text-decoration:none;color:inherit href=#9> 9</a>
</span><span class=lnt id=10><a style=outline:none;text-decoration:none;color:inherit href=#10>10</a>
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=k>class</span> <span class=nc>FixedValueConstraint</span><span class=p>(</span><span class=n>Constraint</span><span class=p>):</span>
<span class=c1>#... </span>
    <span class=k>def</span> <span class=nf>validate_object</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>instance</span><span class=p>):</span>
        <span class=k>pass</span>

    <span class=k>def</span> <span class=nf>apply_reciprocal_constraint</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>instance</span><span class=p>):</span>
        <span class=k>pass</span>

    <span class=k>def</span> <span class=nf>cascade_constraints</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>instance</span><span class=p>):</span>
        <span class=k>pass</span>
</code></pre></td></tr></table>
</div>
</div><p><code>InfluencedConstraint</code> at first feels like it might be a little more complex. Validation is straightforward, it can only apply to another <code>ConstraintSet</code> object, or child object. But what about the reciprocal constraint? In fact, we don&rsquo;t need to do anything here, as the reciprocal object is the &ldquo;higher up one&rdquo;. If, for example, <code>InfluencedConstraint</code> is being applied to <code>p.x</code>, that&rsquo;s because<code>CoincidentConstraint</code> has been applied to <code>p</code> so we already know that the reciprocal constraint isin place, as such we don&rsquo;t need to do anything. Similarly we can make no assumptions as to what constraints will need to be cascaded and we&rsquo;ll leave that to the &ldquo;higher up&rdquo; object should that be necessary:</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt id=1><a style=outline:none;text-decoration:none;color:inherit href=#1> 1</a>
</span><span class=lnt id=2><a style=outline:none;text-decoration:none;color:inherit href=#2> 2</a>
</span><span class=lnt id=3><a style=outline:none;text-decoration:none;color:inherit href=#3> 3</a>
</span><span class=lnt id=4><a style=outline:none;text-decoration:none;color:inherit href=#4> 4</a>
</span><span class=lnt id=5><a style=outline:none;text-decoration:none;color:inherit href=#5> 5</a>
</span><span class=lnt id=6><a style=outline:none;text-decoration:none;color:inherit href=#6> 6</a>
</span><span class=lnt id=7><a style=outline:none;text-decoration:none;color:inherit href=#7> 7</a>
</span><span class=lnt id=8><a style=outline:none;text-decoration:none;color:inherit href=#8> 8</a>
</span><span class=lnt id=9><a style=outline:none;text-decoration:none;color:inherit href=#9> 9</a>
</span><span class=lnt id=10><a style=outline:none;text-decoration:none;color:inherit href=#10>10</a>
</span><span class=lnt id=11><a style=outline:none;text-decoration:none;color:inherit href=#11>11</a>
</span><span class=lnt id=12><a style=outline:none;text-decoration:none;color:inherit href=#12>12</a>
</span><span class=lnt id=13><a style=outline:none;text-decoration:none;color:inherit href=#13>13</a>
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=k>class</span> <span class=nc>InfluencedConstraint</span><span class=p>(</span><span class=n>Constraint</span><span class=p>):</span>
    <span class=c1>#... </span>

    <span class=k>def</span> <span class=nf>validate_object</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>instance</span><span class=p>):</span>
        <span class=k>if</span> <span class=ow>not</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>instance</span><span class=p>,</span> <span class=n>ConstraintSet</span><span class=p>):</span>
            <span class=k>raise</span> <span class=n>InvalidConstraintException</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=vm>__class__</span><span class=o>.</span><span class=vm>__name__</span><span class=si>}</span><span class=s2> can only&#34;</span>
            <span class=sa>f</span><span class=s2>&#34; be applied to `ConstraintSet`, it cannot be applied to `</span><span class=si>{</span><span class=n>point</span><span class=o>.</span><span class=vm>__class__</span><span class=o>.</span><span class=vm>__name__</span><span class=si>}</span><span class=s2>`&#34;</span><span class=p>)</span>

    <span class=k>def</span> <span class=nf>apply_reciprocal_constraint</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>instance</span><span class=p>):</span>
        <span class=k>pass</span>

    <span class=k>def</span> <span class=nf>cascade_constraints</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>instance</span><span class=p>):</span>
        <span class=k>pass</span>
</code></pre></td></tr></table>
</div>
</div><p>We&rsquo;ve already done <code>LinkedValueConstraint</code> so that only leaves <code>CoincidentConstraint</code>. In order todo that we&rsquo;ll need to upgrade our <code>Line</code> object to be able to take constraints, and as this article is already about twice as long as I intended, let&rsquo;s leave that for next time! In the next article we&rsquo;ll look at upgrading our <code>Line</code> to be able to accept <code>Constraint</code> objects, and in so doing we&rsquo;ll walk a path towards some pretty powerful generics.</p>
</div>
</article>
</div>
</main>
<footer class=site-footer>
<div class=wrapper>
<h2 class=footer-heading>Garbage Collection</h2>
<div class=footer-col-wrapper>
<div class="footer-col footer-col-1">
<ul class=contact-list>
<li>
Richard Vodden
</li>
<li><a href=mailto:richard@vodden.com>richard@vodden.com</a></li>
</ul>
</div>
<div class="footer-col footer-col-2">
<ul class=social-media-list>
<li><a href=https://github.com/rvodden><span class="icon icon--github"><svg viewBox="0 0 16 16" width="16" height="16"><path fill="#828282" d="M7.999.431C3.714.431.239 3.905.239 8.192c0 3.428 2.223 6.337 5.307 7.363.388.071.53-.168.53-.374.0-.184-.007-.672-.01-1.32-2.159.469-2.614-1.04-2.614-1.04-.353-.896-.862-1.135-.862-1.135-.705-.481.053-.472.053-.472.779.055 1.189.8 1.189.8.692 1.186 1.816.843 2.258.645.071-.502.271-.843.493-1.037C4.86 11.425 3.049 10.76 3.049 7.786c0-.847.302-1.54.799-2.082C3.768 5.507 3.501 4.718 3.924 3.65c0 0 .652-.209 2.134.796C6.677 4.273 7.34 4.187 8 4.184c.659.003 1.323.089 1.943.261 1.482-1.004 2.132-.796 2.132-.796.423 1.068.157 1.857.077 2.054.497.542.798 1.235.798 2.082.0 2.981-1.814 3.637-3.543 3.829.279.24.527.713.527 1.437.0 1.037-.01 1.874-.01 2.129.0.208.14.449.534.373 3.081-1.028 5.302-3.935 5.302-7.362.0-4.285-3.475-7.76-7.761-7.76z"/></svg>
</span><span class=username>rvodden</span></a>
</li>
<li><a href=https://twitter.com/rvodden><span class="icon icon--twitter"><svg viewBox="0 0 16 16" width="16" height="16"><path fill="#828282" d="M15.969 3.058c-.586.26-1.217.436-1.878.515.675-.405 1.194-1.045 1.438-1.809-.632.375-1.332.647-2.076.793-.596-.636-1.446-1.033-2.387-1.033-1.806.0-3.27 1.464-3.27 3.27.0.256.029.506.085.745C5.163 5.404 2.753 4.102 1.14 2.124.859 2.607.698 3.168.698 3.767c0 1.134.577 2.135 1.455 2.722C1.616 6.472 1.112 6.325.671 6.08c0 .014.0.027.0.041.0 1.584 1.127 2.906 2.623 3.206C3.02 9.402 2.731 9.442 2.433 9.442c-.211.0-.416-.021-.615-.059.416 1.299 1.624 2.245 3.055 2.271-1.119.877-2.529 1.4-4.061 1.4-.264.0-.524-.015-.78-.046 1.447.928 3.166 1.469 5.013 1.469 6.015.0 9.304-4.983 9.304-9.304.0-.142-.003-.283-.009-.423C14.976 4.29 15.531 3.714 15.969 3.058z"/></svg>
</span><span class=username>rvodden</span></a>
</li>
</ul>
</div>
<div class="footer-col footer-col-3">
<p>This is a collection of all the garbage which comes out of my mind.</p>
</div>
</div>
</div>
</footer>
</body>
</html>